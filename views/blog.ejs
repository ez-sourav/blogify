<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/head.ejs') %>
    <title>Blog Page</title>

    <style>
      .blog-image {
        max-height: 350px;
        object-fit: cover;
        border-radius: 12px;
      }

      .comment-user-img {
        width: 45px;
        height: 45px;
        object-fit: cover;
      }
    </style>
  </head>

  <body class="bg-light">
    <%- include('./partials/nav.ejs') %>

    <!-- ======= BLOG CONTENT ======= -->
    <div class="container mt-4">
      <div class="card shadow-sm border-0 rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="fw-bold mb-0"><%= blog.title %></h1>

  <% if (user && user._id.toString() === blog.createdBy._id.toString()) { %>
    <div class="d-flex gap-2">
      <a 
        href="/blog/edit/<%= blog._id %>" 
        class="btn btn-sm btn-outline-warning"
      >
        ‚úèÔ∏è Edit
      </a>

      <form 
        action="/blog/delete/<%= blog._id %>" 
        method="POST"
        onsubmit="return confirm('Are you sure you want to delete this blog?')"
      >
        <button class="btn btn-sm btn-outline-danger">
          üóëÔ∏è Delete
        </button>
      </form>
    </div>
  <% } %>
</div>


        <img 
          src="<%= blog.coverImageURL %>" 
          class="img-fluid blog-image mb-3"
        />

        <pre 
          class="mt-3 p-3 bg-white border rounded"
          style="white-space: pre-wrap; font-size: 16px;"
        ><%= blog.body %></pre>
      </div>
    </div>

    <!-- ======== AUTHOR SECTION ======== -->
    <div class="container mt-4">
      <div class="card shadow-sm border-0 rounded-3 p-3 d-flex align-items-center flex-row gap-3">
        <img
          src="<%= blog.createdBy.profileImageURL %>"
          width="60" height="60"
          class="rounded-circle border"
        />
        <h5 class="fw-semibold mb-0"><%= blog.createdBy.fullName %></h5>
      </div>
    </div>

    <!--====== TIME AGO FUNCTION====== -->
    <%
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);

      let interval = seconds / 31536000;
      if (interval > 1) return Math.floor(interval) + " years ago";

      interval = seconds / 2592000;
      if (interval > 1) return Math.floor(interval) + " months ago";

      interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + " days ago";

      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + " hours ago";

      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + " minutes ago";

      return "Just now";
    }
    %>

    <!-- ======== COMMENTS SECTION ======== -->
    <div class="container mt-4 mb-5">
      <div class="card shadow-sm rounded-3 border-0 p-4">

        <h3 class="fw-bold mb-4">Comments (<%= comments.length %>)</h3>

        <!-- Add Comment Box -->
        <% if (locals.user) { %>
        <form action="/blog/comment/<%= blog._id %>" method="post" class="mb-4">
          <div class="input-group">
            <input 
              type="text" 
              class="form-control"
              name="content"
              placeholder="Write a comment..."
              required
            >
            <button class="btn btn-primary" type="submit">Post</button>
          </div>
        </form>
        <% } %>

        <!-- Comments List -->
        <div class="list-group">
          <% comments.forEach(comment => { %>
            <div class="list-group-item border-0 border-bottom py-3">
              <div class="d-flex align-items-start gap-3">
                
                <!-- Comment User Image -->
                <img 
                  src="<%= comment.createdBy.profileImageURL %>" 
                  class="rounded-circle border comment-user-img"
                />

                <div>
                  <h6 class="fw-semibold mb-1">
                    <%= comment.createdBy.fullName %>
                    <small class="text-muted ms-2" style="font-size: 12px;">
                      ‚Ä¢ <%= timeAgo(comment.createdAt) %>
                    </small>
                  </h6>

                  <p class="mb-0"><%= comment.content %></p>
                </div>

              </div>
            </div>
          <% }) %>
        </div>

      </div>
    </div>

    <%- include('./partials/footer.ejs') %>
    <%- include('./partials/script.ejs') %>
  </body>
</html>
